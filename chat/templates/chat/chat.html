<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My Chat</title>
</head>
<body>
    <h1>My Chat</h1>

    <!-- エンターキーによるボタン押下を行うために、<button>ではなく<form>と<input type="submit">を使用。
    ボタン押下(=submit)時にページリロードが行われないように、onsubmitの設定の最後に"return false;"を追加。-->
    <form action="" onsubmit="onsubmitButton_send();return false;">
        Message : <input type="text" id="input_message" autocomplete="off" autofocus /><input type="submit" value="Send" />
    </form>

    <ul id="list_message"></ul>
    <input type="file" id="inputImage">

    <script>
        const g_elementInputMessge = document.getElementById("input_message");
        const g_elementListMessage = document.getElementById("list_message");
        const imageInput = document.getElementById("inputImage");

        //WebSocketオブジェクト
        let ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        const g_socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/chat/");

        //Sendボタンを押した時の処理
        function onsubmitButton_send()
        {
            let message = g_elementInputMessge.value;
            if(!message)
            {
                return;
            }

            //WebSocketを通したメッセージの送信
            g_socket.send(JSON.stringify({ "message":message }));
            //送信用テキストHTML要素の中身のクリア
            g_elementInputMessge.value = "";
        }

        const imageInput = document.getElementById("inputImage");

        imageInput.addEventListener('change', (e) => {
            const imageFile = e.target.files[0];
            const imageURL = window.URL.createObjectURL(imageFile);

            const imageElement = new Image();
            imageElement.src = imageURL;

            imageElement.onload = function() {
                const canvasElement = document.createElement('canvas');
                canvasElement.width = imageElement.width;
                canvasElement.height = imageElement.height;
                const canvasContext = canvasElement.getContext('2d');
                canvasContext.drawImage(imageElement, 0, 0);

                // canvas要素をbase64形式に変換
                imageBase64 = createElement.toDataURL("image/png");
            };
        });

        //WebSocketからメッセージ受信時の処理
        g_socket.onmessage = (event) => {
            //テキストデータをJSONデータにデコード
            let data = JSON.parse(event.data);

            //メッセージの整形
            let message = data["message"];

            //拡散されたメッセージをメッセージリストに追加
            let elementLi = document.createElement("li");
            elementLi.textContent = message;
            g_elementListMessage.prepend( elementLi ); //リストの一番上に追加
            // g_elementListMessge.append( elementLi ); //リストの一番下に追加

            let messageImage = document.createElement('img');
            messageImage.setAttribute('src', data["image"]);
            message.append(messageImage);
        };

        // WebSocketクローズ時の処理
        g_socket.onclose = (event) => {
            //ウェブページを閉じた時以外のWebSocketクローズは想定外
            console.error("Unexpected : Chat socket closed.");
        };
    </script>

</body>

</html>